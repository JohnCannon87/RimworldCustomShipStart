<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RimWorld Ship Designer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family: 'Arial', sans-serif; padding: 20px; }
#grid { display: grid; grid-gap: 1px; margin-bottom: 20px; }
.cell { width: 30px; height: 30px; border: 1px solid #ccc; cursor: pointer; text-align: center; line-height: 30px; font-size: 12px; position: relative;}
.type-0 { background-color: #fff; }
.type-1 { background-color: #f0f0f0; }
.type-2 { background-color: #999; color:white; }
.type-3 { background-color: #f90; }
.type-4 { background-color: #e99; }
.type-5 { background-color: #d38; }
.type-grav { background-color: #a3d5ff; } /* Light blue highlight for grav engine */

/* Placeholder stripe styles */
.placeholder-red {
  background: repeating-linear-gradient(45deg, #ff4c4c, #ff4c4c 10px, #ff9999 10px, #ff9999 20px);
}
.placeholder-blue {
  background: repeating-linear-gradient(45deg, #4c6dff, #4c6dff 10px, #99aaff 10px, #99aaff 20px);
}
.placeholder-green {
  background: repeating-linear-gradient(45deg, #3cb371, #3cb371 10px, #7bdba2 10px, #7bdba2 20px);
}
.placeholder-yellow {
  background: repeating-linear-gradient(45deg, #e6c300, #e6c300 10px, #ffe766 10px, #ffe766 20px);
}
.placeholder-purple {
  background: repeating-linear-gradient(45deg, #8a2be2, #8a2be2 10px, #b084f5 10px, #b084f5 20px);
}

#thingPanel { border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; }
#thingPanel h2 { font-size: 16px; margin-bottom: 10px; }
#thingPanel textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
#xmlOutput { width: 100%; height: 250px; font-family: monospace; font-size: 14px; }
#xmlInput { width: 100%; height: 100px; font-family: monospace; font-size: 14px; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="container-fluid">
  <!-- Input XML row -->
  <div class="row mb-3">
    <div class="col-12">
      <label for="xmlInput" class="form-label">Input XML (Paste here to import)</label>
      <textarea id="xmlInput" placeholder="Paste structureRows XML here..."></textarea>
      <button class="btn btn-info mt-1" onclick="importXML()">Import XML</button>
    </div>
  </div>

  <div class="row">
    <!-- Left panel: grid + controls -->
    <div class="col-md-8">
      <h1>RimWorld Ship Designer</h1>

      <div class="row mb-3">
        <div class="col-md-3">
          <label for="tileType" class="form-label">Tile Type</label>
          <select id="tileType" class="form-select">
            <option value="0">Empty</option>
            <option value="1">Substructure</option>
            <option value="2">Hull</option>
            <option value="3">Door</option>
            <option value="4">AutoDoor</option>
            <option value="5">VacBarrier</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="rows" class="form-label">Rows</label>
          <input type="number" id="rows" class="form-control" value="9" min="1">
        </div>
        <div class="col-md-2">
          <label for="cols" class="form-label">Columns</label>
          <input type="number" id="cols" class="form-control" value="10" min="1">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary me-2" onclick="generateGrid()">Generate Grid</button>
          <button class="btn btn-success me-2" onclick="updateXMLOutput()">Export XML</button>
        </div>
      </div>

      <!-- Grav Engine Inputs -->
      <div class="row mb-3">
        <div class="col-md-2">
          <label class="form-label">Grav Engine X</label>
          <input type="number" id="gravX" class="form-control" min="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">Grav Engine Z</label>
          <input type="number" id="gravZ" class="form-control" min="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">Grav Engine Radius</label>
          <input type="number" id="gravRadius" class="form-control" min="0" step="0.1" value="18.9">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-warning" onclick="placeGravEngine()">Place Grav Engine</button>
        </div>
      </div>

      <!-- Placeholder style controls -->
      <div class="row mb-3">
        <div class="col-12">
          <strong>Placeholder Tools: </strong>
          <button class="btn btn-outline-danger btn-sm me-1" onclick="setPlaceholderStyle('red')">Red</button>
          <button class="btn btn-outline-primary btn-sm me-1" onclick="setPlaceholderStyle('blue')">Blue</button>
          <button class="btn btn-outline-success btn-sm me-1" onclick="setPlaceholderStyle('green')">Green</button>
          <button class="btn btn-outline-warning btn-sm me-1" onclick="setPlaceholderStyle('yellow')">Yellow</button>
          <button class="btn btn-outline-secondary btn-sm me-1" onclick="setPlaceholderStyle('purple')">Purple</button>
          <button class="btn btn-dark btn-sm" onclick="clearPlaceholders()">Clear All</button>
        </div>
      </div>

      <!-- Structure count display -->
      <div class="mb-2">
        <strong>Structure Cells Count: </strong><span id="structureCount">0</span>
      </div>

      <div id="grid" class="mb-3"></div>
    </div>

    <!-- Right panel: thing panel -->
    <div class="col-md-4" id="thingPanel">
      <h2>Add Thing</h2>
      <textarea id="thingXML" placeholder="Right-click a cell to add thing coordinates here"></textarea>
    </div>
  </div>

  <!-- Bottom row: XML output -->
  <div class="row">
    <div class="col-12">
      <h2>Output XML (Read-only)</h2>
      <textarea id="xmlOutput" readonly></textarea>
    </div>
  </div>
</div>

<script>
const tileTypes = ['0','1','2','3'];
const tileClass = ['type-0','type-1','type-2','type-3','type-4','type-5'];
let grid = [];
let mouseDown = false;
let middleMouseDown = false;
let nextNumber = 1; 
let gravEngineX = null;
let gravEngineZ = null;
let gravEngineRadius = 18.9; 
let activePlaceholderStyle = "green"; // default

function numberToWords(num) {
  const belowTwenty = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine",
                       "Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen",
                       "Sixteen","Seventeen","Eighteen","Nineteen"];
  const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
  if(num < 20) return belowTwenty[num];
  const ten = Math.floor(num/10);
  const unit = num % 10;
  return unit === 0 ? tens[ten] : tens[ten] + belowTwenty[unit];
}

function generateGrid(newRows=parseInt(document.getElementById('rows').value),
                      newCols=parseInt(document.getElementById('cols').value)) {

  const oldGrid = grid;
  const oldRows = oldGrid.length;
  const oldCols = oldGrid[0]?.length || 0;

  const newGrid = Array.from({length: newRows}, () => 
                  Array.from({length: newCols}, () => ({tile:0, number:0, isGrav:false, placeholder:false})));

  if(gravEngineX !== null && gravEngineZ !== null){
    const centerRow = Math.floor(newRows / 2);
    const centerCol = Math.floor(newCols / 2);
    const rowOffset = centerRow - gravEngineZ;
    const colOffset = centerCol - gravEngineX;

    for(let r=0;r<oldRows;r++){
      for(let c=0;c<oldCols;c++){
        const newR = r + rowOffset;
        const newC = c + colOffset;
        if(newR >=0 && newR < newRows && newC >=0 && newC < newCols){
          newGrid[newR][newC] = {...oldGrid[r][c]};
        }
      }
    }

    gravEngineZ += rowOffset;
    gravEngineX += colOffset;
  } else {
    for(let r=0;r<Math.min(oldRows,newRows);r++){
      for(let c=0;c<Math.min(oldCols,newCols);c++){
        newGrid[r][c] = {...oldGrid[r][c]};
      }
    }
  }

  grid = newGrid;
  nextNumber = 1;
  grid.flat().forEach(cell => { if(cell.number >= nextNumber) nextNumber = cell.number + 1; });

  const gridContainer = document.getElementById('grid');
  gridContainer.innerHTML = '';
  gridContainer.style.gridTemplateColumns = `repeat(${newCols},30px)`;
  
  for(let r=0;r<newRows;r++){
    for(let c=0;c<newCols;c++){
      const cell = document.createElement('div');
      cell.className = `cell ${tileClass[grid[r][c].tile]}`;
      if(grid[r][c].isGrav) cell.classList.add('type-grav');
      if(grid[r][c].placeholder) cell.classList.add('placeholder');
      if(grid[r][c].number>0) cell.textContent = grid[r][c].number;

      cell.dataset.row = r;
      cell.dataset.col = c;

      cell.addEventListener('mousedown', e => {
        e.preventDefault();
        if(e.button===0) { mouseDown = true; paintCell(r,c); }
        if(e.button===1) { middleMouseDown = true; togglePlaceholder(r,c); }
      });

      cell.addEventListener('mouseenter', e => {
        if(mouseDown) paintCell(r,c);
        if(middleMouseDown) togglePlaceholder(r,c);
      });

      cell.addEventListener('contextmenu', e => { e.preventDefault(); handleRightClick(r,c); });

      gridContainer.appendChild(cell);
    }
  }

  document.body.addEventListener('mouseup', ()=>{ mouseDown=false; middleMouseDown=false; });

  if(gravEngineX!==null && gravEngineZ!==null){
    highlightGravEngine();
    drawGravRange();
  }

  updateXMLOutput();
  updateStructureCount();
}

function paintCell(r,c){
  const tileType = parseInt(document.getElementById('tileType').value);
  grid[r][c].tile = tileType;
  const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
  if(cell){
    cell.className = `cell ${tileClass[tileType]}`;
    if(grid[r][c].isGrav) cell.classList.add('type-grav');
    if(grid[r][c].placeholder) cell.classList.add('placeholder');
    cell.textContent = grid[r][c].number > 0 ? grid[r][c].number : '';
  }
  updateXMLOutput();
  updateStructureCount();
}

function setPlaceholderStyle(style){
  activePlaceholderStyle = style;
}

function clearPlaceholders(){
  for(let r=0;r<grid.length;r++){
    for(let c=0;c<grid[0].length;c++){
      grid[r][c].placeholder = false;
      grid[r][c].placeholderStyle = null;
      const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
      if(cell){
        cell.classList.remove("placeholder-red","placeholder-blue","placeholder-green","placeholder-yellow","placeholder-purple");
      }
    }
  }
}

function togglePlaceholder(r,c){
  const cellObj = grid[r][c];
  if(cellObj.placeholder && cellObj.placeholderStyle === activePlaceholderStyle){
    cellObj.placeholder = false;
    cellObj.placeholderStyle = null;
  } else {
    cellObj.placeholder = true;
    cellObj.placeholderStyle = activePlaceholderStyle;
  }
  const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
  if(cell){
    cell.classList.remove("placeholder-red","placeholder-blue","placeholder-green","placeholder-yellow","placeholder-purple");
    if(cellObj.placeholder){
      cell.classList.add(`placeholder-${cellObj.placeholderStyle}`);
    }
  }
}


function handleRightClick(r,c){
  const cellObj = grid[r][c];
  if(cellObj.number){
    cellObj.number = 0;
  } else {
    cellObj.number = nextNumber++;
  }
  const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
  if(cell){
    cell.textContent = cellObj.number > 0 ? cellObj.number : '';
    cell.className = `cell ${tileClass[cellObj.tile]}`;
    if(cellObj.isGrav) cell.classList.add('type-grav');
    if(cellObj.placeholder) cell.classList.add('placeholder');
  }
  if(cellObj.number > 0) fillThingPanelFromNumber(c,r,cellObj.number);
}

function fillThingPanelFromNumber(x,z,number){
  const word = numberToWords(number);
  const template = `<li>\n  <x>${x}</x>\n  <z>${z}</z>\n  <thingDef>${word}</thingDef>\n  <rot>ENTERROTATIONHERE</rot>\n</li>`;
  const thingArea = document.getElementById('thingXML');
  thingArea.value += template + '\n';
}

function updateStructureCount(){
  let count = 0;
  for(const row of grid){
    for(const cell of row){
      if(cell.tile > 0) count++;
    }
  }
  document.getElementById('structureCount').textContent = count;
}

function placeGravEngine(){
  const x = parseInt(document.getElementById('gravX').value);
  const z = parseInt(document.getElementById('gravZ').value);
  const r = parseFloat(document.getElementById('gravRadius').value);
  if(isNaN(x) || isNaN(z) || isNaN(r)) { alert("Enter valid coordinates and radius"); return; }

  gravEngineX = x;
  gravEngineZ = z;
  gravEngineRadius = r;

  highlightGravEngine();
  drawGravRange();
  updateXMLOutput();
  updateStructureCount();
}

function highlightGravEngine(){
  grid.forEach((row,r) => row.forEach((cell,c)=>{
    if(cell.isGrav){
      cell.isGrav = false;
      const domCell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
      if(domCell){
        domCell.className = `cell ${tileClass[cell.tile]}`;
        if(cell.number > 0) domCell.textContent = cell.number;
        if(cell.placeholder) domCell.classList.add('placeholder');
      }
    }
  }));

  for(let dz=-1; dz<=1; dz++){
    for(let dx=-1; dx<=1; dx++){
      const r = gravEngineZ + dz;
      const c = gravEngineX + dx;
      if(grid[r] && grid[r][c] !== undefined){
        grid[r][c].tile = 1;
        grid[r][c].isGrav = true;
        const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cell){
          cell.className = `cell ${tileClass[1]} type-grav`;
          if(grid[r][c].number > 0) cell.textContent = grid[r][c].number;
          if(grid[r][c].placeholder) cell.classList.add('placeholder');
        }
      }
    }
  }
}

function drawGravRange(){
  document.querySelectorAll('.cell').forEach(cell => cell.style.boxShadow = '');
  const radius = gravEngineRadius;
  for(let r=0;r<grid.length;r++){
    for(let c=0;c<grid[0].length;c++){
      const dist = Math.sqrt((c - gravEngineX)**2 + (r - gravEngineZ)**2);
      if(Math.abs(dist - radius) <= 0.5){
        const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cell) cell.style.boxShadow = '0 0 0 2px rgba(255,0,0,0.8) inset';
      }
    }
  }
}

function updateXMLOutput(){
  let xml = '';
  if(gravEngineX !== null && gravEngineZ !== null){
    xml += `<gravEngineXCoord>${gravEngineX}</gravEngineXCoord>\n`;
    xml += `<gravEngineZCoord>${gravEngineZ}</gravEngineZCoord>\n`;
  }
  xml += '<structureRows>\n';
  for(const row of grid){
    xml += '  <li>' + row.map(cell => cell.tile).join('') + '</li>\n';
  }
  xml += '</structureRows>';
  document.getElementById('xmlOutput').value = xml;
}

function importXML(){
  const xmlText = document.getElementById('xmlInput').value;
  if(!xmlText) { alert("Paste XML into the input box to import"); return; }

  try{
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText,"application/xml");

    const gravXEl = xml.getElementsByTagName('gravEngineXCoord')[0];
    const gravZEl = xml.getElementsByTagName('gravEngineZCoord')[0];
    gravEngineX = gravXEl ? parseInt(gravXEl.textContent) : null;
    gravEngineZ = gravZEl ? parseInt(gravZEl.textContent) : null;
    if(gravEngineX !== null) document.getElementById('gravX').value = gravEngineX;
    if(gravEngineZ !== null) document.getElementById('gravZ').value = gravEngineZ;

    const structureRowsEl = xml.getElementsByTagName('structureRows')[0];
    if(!structureRowsEl) { alert("No <structureRows> found"); return; }

    const liNodes = Array.from(structureRowsEl.getElementsByTagName('li'));
    const rows = liNodes.length;
    const cols = liNodes[0]?.textContent.length || 10;
    document.getElementById('rows').value = rows;
    document.getElementById('cols').value = cols;

    generateGrid(rows, cols);

    liNodes.forEach((li,r)=>{
      const rowStr = li.textContent.trim();
      rowStr.split('').forEach((val,c)=>{
        grid[r][c].tile = parseInt(val);
        grid[r][c].number = 0;
        const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cell){
          cell.className = `cell ${tileClass[val]}`;
          cell.textContent = '';
        }
      });
    });

    if(gravEngineX !== null && gravEngineZ !== null){
      highlightGravEngine();
      drawGravRange();
    }

    updateXMLOutput();
    updateStructureCount();
  }catch(e){
    alert("Error parsing XML: " + e.message);
  }
}

window.onload = ()=>generateGrid();
</script>

</body>
</html>
